<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>실행 취소 / 다시 실행 기능 구현하기(feat. serializr) | Coderifleman&#39;s blog</title>
  
    <meta name="description" content="실행 취소 / 다시 실행(Undo/Redo) 기능을 어떻게 구현할 수 있는지 자바스크립트 라이브러리 serializr와 함께 단계별로 자세히 설명합니다.">
  
  
    <meta name="keywords" content="Programming,Development,Web Developer,FrontEnd Developer,Web,FrontEnd,Architecture,UI,UX,Development,JavaScript,Architecture,Undo/Redo">
  
  
    <meta name="author" content="Coderifleman">
  
  
    <link rel="alternate" href="/atom.xml" title="Coderifleman&#39;s blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <meta name="description" content="실행 취소 &#x2F; 다시 실행(Undo&#x2F;Redo) 기능을 어떻게 구현할 수 있는지 자바스크립트 라이브러리 serializr와 함께 단계별로 자세히 설명합니다.">
<meta property="og:type" content="article">
<meta property="og:title" content="실행 취소 &#x2F; 다시 실행 기능 구현하기(feat. serializr)">
<meta property="og:url" content="http://blog.coderifleman.com/2019/06/29/create-the-undo-redo-feature/index.html">
<meta property="og:site_name" content="Coderifleman&#39;s blog">
<meta property="og:description" content="실행 취소 &#x2F; 다시 실행(Undo&#x2F;Redo) 기능을 어떻게 구현할 수 있는지 자바스크립트 라이브러리 serializr와 함께 단계별로 자세히 설명합니다.">
<meta property="og:locale" content="ko_KR">
<meta property="og:image" content="http://blog.coderifleman.com/images/create-the-undo-redo-feature/undo-redo.00.jpg">
<meta property="og:image" content="http://blog.coderifleman.com/images/create-the-undo-redo-feature/undo-redo.01.png">
<meta property="og:image" content="http://blog.coderifleman.com/images/2019/create-the-undo-redo-feature/undo-redo.02.png">
<meta property="article:published_time" content="2019-06-28T15:00:00.000Z">
<meta property="article:modified_time" content="2022-11-09T05:45:21.010Z">
<meta property="article:author" content="Coderifleman">
<meta property="article:tag" content="Development">
<meta property="article:tag" content="JavaScript">
<meta property="article:tag" content="Architecture">
<meta property="article:tag" content="Undo&#x2F;Redo">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://blog.coderifleman.com/images/create-the-undo-redo-feature/undo-redo.00.jpg">
<meta name="twitter:creator" content="@coderifleman">
<meta name="twitter:site" content="http://blog.coderifleman.com/2019/06/29/create-the-undo-redo-feature/index.html">
  
<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Nanum+Myeongjo:400,700&display=swap.css">

  
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css">

  
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/themes/prism-tomorrow.min.css" media="(prefers-color-scheme: dark)">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/themes/prism-solarizedlight.min.css" media="(prefers-color-scheme: no-preference), (prefers-color-scheme: light)">
  
<link rel="stylesheet" href="/style.css">

  <link rel="stylesheet" href="/dark.css" media="(prefers-color-scheme: dark)">
<meta name="generator" content="Hexo 5.4.0"></head>
<body>

<div class="root">
  <header class="header">
  <div class="header__picture">
    <a href="/">
      <img src="/images/common/author.png" alt="Coderifleman's Picture"/>
    </a>
  </div>
  <div class="header__detail">
    <h1 class="header__title">
      <a href="/">
        Coderifleman&#39;s blog
      </a>
    </h1>
    <p class="header__subtitle">frontend development stories.</p>
    <div class="header__media">
      <ul class="media">
  
    
      <li class="media__medium">
        
          <a href="mailto:uyeong21c@gmail.com">
            <i class="fa fa-envelope-o" aria-hidden="true"></i>
            <span class="blind">Email</span>
          </a>
        
      </li>
    
  
    
      <li class="media__medium">
        
          <a href="//twitter.com/coderifleman" target="_blank">
            <i class="fa fa-twitter" aria-hidden="true"></i>
            <span class="blind">Twitter</span>
          </a>
        
      </li>
    
  
    
      <li class="media__medium">
        
          <a href="//facebook.com/coderifleman" target="_blank">
            <i class="fa fa-facebook" aria-hidden="true"></i>
            <span class="blind">Facebook</span>
          </a>
        
      </li>
    
  
    
      <li class="media__medium">
        
          <a href="//github.com/uyeong" target="_blank">
            <i class="fa fa-github" aria-hidden="true"></i>
            <span class="blind">Github</span>
          </a>
        
      </li>
    
  
    
      <li class="media__medium">
        
          <a href="/atom.xml" target="_blank">
            <i class="fa fa-rss" aria-hidden="true"></i>
            <span class="blind">RSS</span>
          </a>
        
      </li>
    
  
</ul>

    </div>
  </div>
</header>

  <section class="post">
  <div class="post__inner">
    <article class="post__body">
      <div class="post__header">
        <h1 class="post__title">실행 취소 / 다시 실행 기능 구현하기(feat. serializr)</h1>
        <div class="post__meta">
          <div class="meta">
  <div class="meta__datetime">
    <i class="fa fa-clock-o" aria-hidden="true"></i>
    <time datetime="2019-06-29T00:00:00+09:00">
      2019.06.29
    </time>
  </div>
  <div class="meta__categories ellipsis">
    <i class="fa fa-map-marker" aria-hidden="true"></i>
    
      <div class="meta__category-list">
        
          <a href="/categories/JavaScript/" class="meta__category-list-item">
            <span>JavaScript</span>
          </a>
          
            <span>&nbsp/ </span>
          
        
          <a href="/categories/JavaScript/Implementation/" class="meta__category-list-item">
            <span>Implementation</span>
          </a>
          
        
      </div>
    
  </div>
</div>

        </div>
        <div class="post__tags">
          <div class="tags">
  <ul class="tags__list">
    
      
        <li class="tags__item">
          <a class="tags__link" href="/tags/Development/" >
            #Development
          </a>
        </li>
      
        <li class="tags__item">
          <a class="tags__link" href="/tags/JavaScript/" >
            #JavaScript
          </a>
        </li>
      
        <li class="tags__item">
          <a class="tags__link" href="/tags/Architecture/" >
            #Architecture
          </a>
        </li>
      
        <li class="tags__item">
          <a class="tags__link" href="/tags/Undo-Redo/" >
            #Undo/Redo
          </a>
        </li>
      
    
  </ul>
</div>

        </div>
      </div>
      
      
        <aside class="post__toc">
          <h2>목차</h2>
          <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%EC%98%88%EC%A0%9C-%EC%86%8C%EA%B0%9C"><span class="toc-number">1.</span> <span class="toc-text">예제 소개</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%EB%AA%A8%EB%8D%B8"><span class="toc-number">1.1.</span> <span class="toc-text">모델</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%ED%91%9C%ED%98%84"><span class="toc-number">1.2.</span> <span class="toc-text">표현</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EC%9D%B4%EB%B2%A4%ED%8A%B8-%ED%95%B8%EB%93%A4%EB%9F%AC"><span class="toc-number">1.3.</span> <span class="toc-text">이벤트 핸들러</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%EA%B5%AC%ED%98%84%ED%95%98%EA%B8%B0"><span class="toc-number">2.</span> <span class="toc-text">구현하기</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#serializr-%EC%86%8C%EA%B0%9C"><span class="toc-number">2.1.</span> <span class="toc-text">serializr 소개</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EB%AA%A8%EB%8D%B8-%EC%88%98%EC%A0%95"><span class="toc-number">2.2.</span> <span class="toc-text">모델 수정</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#History-%EC%9E%91%EC%84%B1"><span class="toc-number">2.3.</span> <span class="toc-text">History 작성</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EC%9D%B4%EB%B2%A4%ED%8A%B8-%ED%95%B8%EB%93%A4%EB%9F%AC-%EC%88%98%EC%A0%95"><span class="toc-number">2.4.</span> <span class="toc-text">이벤트 핸들러 수정</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EA%B2%B0%EA%B3%BC"><span class="toc-number">2.5.</span> <span class="toc-text">결과</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%EB%81%9D%EC%9C%BC%EB%A1%9C"><span class="toc-number">3.</span> <span class="toc-text">끝으로</span></a></li></ol>
        </aside>
      
      <div class="post__contents">
        
    <figure title="undefined">
      <a href="/images/create-the-undo-redo-feature/undo-redo.00.jpg" target="_blank">
        <img 
          src="/images/create-the-undo-redo-feature/undo-redo.00.jpg" 
          alt="" 
          style=""
        >
      </a>
      
    </figure>
  

<p>이 문서는 자바스크립트 라이브러리 <a target="_blank" rel="noopener" href="https://github.com/mobxjs/serializr">serializr</a>를 사용하여 실행 취소 / 다시 실행 구현 방법을 소개한다. 이와 같은 기능을 구현하는 데 있어 적게나마 도움이 되길 바란다.</p>
<h2 id="예제-소개"><a href="#예제-소개" class="headerlink" title="예제 소개"></a>예제 소개</h2>
    <p data-height="300" data-theme-id="0" data-slug-hash="RzZBdX" data-default-tab="result" data-user="uyeong" data-embed-version="2" data-pen-title="RzZBdX" class="codepen">
      See the Pen <a target="_blank" rel="noopener" href="http://codepen.io/uyeong/pen/RzZBdX/">RzZBdX</a> by Uyeong Ju (<a target="_blank" rel="noopener" href="http://codepen.io/uyeong">@uyeong</a>) on <a target="_blank" rel="noopener" href="http://codepen.io">CodePen</a>.
    </p>
  

<p>이해를 돕기 위해 원, 사각형, 삼각형 중 하나를 생성하고, 끌어다 놓거나 삭제할 수 있는 간단한 애플리케이션을 준비했다. 여기에 실행 취소 / 다시 실행 기능을 추가하고자 한다. 하지만 그 전에 애플리케이션의 구조를 모델, 표현(presentation), 이벤트 핸들러로 나눠 간단히 살펴보고 넘어가자.</p>
<h3 id="모델"><a href="#모델" class="headerlink" title="모델"></a>모델</h3>
    <figure title="모델 구조와 표현 관계">
      <a href="/images/create-the-undo-redo-feature/undo-redo.01.png" target="_blank">
        <img 
          src="/images/create-the-undo-redo-feature/undo-redo.01.png" 
          alt="모델 구조와 표현 관계" 
          style=""
        >
      </a>
      <figcaption>&lt;모델 구조와 표현 관계&gt;</figcaption>
    </figure>
  

<p>모델은 <code>Shape</code>와 이를 상속받는 <code>Circle</code>, <code>Square</code>, <code>Triangle</code>이 있고 <code>Shape</code>를 관리하는 컬렉션 객체 <code>Shapes</code>가 있다. <code>Shapes</code>는 <code>Shape</code>를 관리할 뿐만 아니라 <code>Shape</code>에 대한 상태 변경도 담당한다. 즉, 이벤트 핸들러에서 <code>Shape</code>의 상태를 변경하고 싶은 경우 <code>Shapes</code>에 위임한다. </p>
<p>이렇게 작성한 이유는 변경에 대한 통지를 <code>Shapes</code>에서 총괄하기 위해서다. 표현은 <code>Shapes</code>만 구독하면 되기 때문에 단순하게 구현할 수 있다. 이 방법이 낯설지 모르겠지만 필자는 현 예제 규모에 잘 어울린다고 생각했다.</p>
<h3 id="표현"><a href="#표현" class="headerlink" title="표현"></a>표현</h3><pre class="language-js" data-language="js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> bind<span class="token punctuation">,</span> wire <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'https://dev.jspm.io/hyperhtml/esm'</span><span class="token punctuation">;</span>

<span class="token operator">...</span>
<span class="token keyword">const</span> graphic <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.graphic'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> render <span class="token operator">=</span> <span class="token function">bind</span><span class="token punctuation">(</span>graphic<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> shapes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Shapes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  render<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"> 
      ... 
    &lt;/svg>
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
shapes<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span>update<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p>이어서 <code>update()</code>를 살펴보자. 이 함수는 모델을 토대로 UI를 렌더링하는 즉, 표현을 위한 함수다. 표현에는 <a target="_blank" rel="noopener" href="https://github.com/WebReflection/hyperHTML">hyperHTML</a>을 사용했다. hyperHTML은 Template literal 문법으로 UI를 만들 수 있는 작고 가벼운 라이브러리다. </p>
<p>먼저 <code>update()</code>를 호출해 SVG를 렌더링한다. 그리고 <code>shapes.on()</code>에 <code>update()</code>를 등록한다. 이로써 모델에 어떠한 변경이 있을 때마다 <code>update()</code>가 호출돼 자동으로 UI가 갱신된다.   </p>
<h3 id="이벤트-핸들러"><a href="#이벤트-핸들러" class="headerlink" title="이벤트 핸들러"></a>이벤트 핸들러</h3><pre class="language-js" data-language="js"><code class="language-js">addCircle<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token function">create</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> Circle<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
addSquare<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token function">create</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> Square<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
addTriangle<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token function">create</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> Triangle<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
remove<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span> <span class="token operator">...</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// ... 중략 ...</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'ontouchstart'</span> <span class="token keyword">in</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  docEl<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'touchstart'</span><span class="token punctuation">,</span> handlePointerStart<span class="token punctuation">)</span><span class="token punctuation">;</span>
  docEl<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'touchmove'</span><span class="token punctuation">,</span> handlePointerMove<span class="token punctuation">)</span><span class="token punctuation">;</span>
  docEl<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'touchend'</span><span class="token punctuation">,</span> handlePointerEnd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
  docEl<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'mousedown'</span><span class="token punctuation">,</span> handlePointerStart<span class="token punctuation">)</span><span class="token punctuation">;</span>
  docEl<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'mousemove'</span><span class="token punctuation">,</span> handlePointerMove<span class="token punctuation">)</span><span class="token punctuation">;</span>
  docEl<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'mouseup'</span><span class="token punctuation">,</span> handlePointerEnd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>마지막으로 이벤트 핸들러를 살펴보자. 이벤트 핸들러는 도형을 추가하거나 삭제하는 버튼과 끌어다 놓을 수 있도록 <code>documentElement</code>에 등록하고 구현했다. </p>
<p>여기에서는 이벤트 핸들러의 구체적인 부분까지 설명하지 않는다. 하지만 다음 절을 원활히 이해하기 위해 이벤트 핸들러를 통해 어떻게 모델을 변경하고 있는지 한번 살펴보길 바란다. </p>
<h2 id="구현하기"><a href="#구현하기" class="headerlink" title="구현하기"></a>구현하기</h2><p>실행 취소 / 다시 실행을 구현하는 방법에는 크게 복사본(snapshot)을 저장하는 방식과 명령(command)을 저장하는 방식이 있다. 여기에서는 복사본을 저장하는 방식을 사용한다.</p>
<p>복사본을 저장하는 방식이란 모델의 상태를 JSON이나 플레인 자바스크립트 객체 형태로 저장해 두었다가 필요할 때 되돌리는 방법을 말한다. 이때 모델을 JSON이나 플레인 자바스크립트 객체 형태로 변환하는 과정을 직렬화(serialize)라고 하며, 복사본을 다시 본래의 모델로 되돌리는 것을 역직렬화(deserialize)라고 한다.</p>
<h3 id="serializr-소개"><a href="#serializr-소개" class="headerlink" title="serializr 소개"></a>serializr 소개</h3><p>모델(객체)의 상태를 직렬화 또는 역직렬화 하기 위해선 추가적인 작업이 필요하다. 예를 들어 객체에 <code>toJSON()</code>을 추가하고 객체 관계를 순회하여 플레인 자바스크립트 객체를 만들 수 있다. 그리고 생성한 플레인 자바스크립트 객체를 다시 순회하면서 적절한 생성자를 찾아 본래의 모델로 되돌릴 수 있다. </p>
<p>글로 설명하면 단순하지만 사실 꽤 따분한 작업이다. 또, 협업 개발자 모두가 이해할 수 있는 적절한 구조를 설계하기도 쉽지 않다. </p>
<p>이 역할을 충실히 수행하는 자바스크립트 라이브러리가 바로 <a target="_blank" rel="noopener" href="https://github.com/mobxjs/serializr">serializr</a>다. serializr는 <a target="_blank" rel="noopener" href="https://github.com/mobxjs/mobx">Mobx</a>의 서드 파티 라이브러리지만 그렇다고 Mobx를 의존하진 않는다. 따라서 다른 환경에서도 무리 없이 사용할 수 있다.</p>
<h3 id="모델-수정"><a href="#모델-수정" class="headerlink" title="모델 수정"></a>모델 수정</h3><p>그럼 모델을 serialzr를 이용해 직렬화 가능하게 수정해보자.</p>
<pre class="language-js" data-language="js"><code class="language-js"><span class="token keyword">import</span> serializr <span class="token keyword">from</span> <span class="token string">'https://dev.jspm.io/serializr'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">&#123;</span> createModelSchema<span class="token punctuation">,</span> serialize<span class="token punctuation">,</span> deserialize<span class="token punctuation">,</span> primitive<span class="token punctuation">,</span> list <span class="token punctuation">&#125;</span> <span class="token operator">=</span> serializr<span class="token punctuation">;</span></code></pre>

<p>먼저 serializr를 불러오고 구현에 사용할 함수를 몇 개 추린다.</p>
<pre class="language-js" data-language="js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Shape</span> <span class="token punctuation">&#123;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">data <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token operator">...</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>posX <span class="token operator">=</span> posX<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>posY <span class="token operator">=</span> posY<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>tempX <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>tempY <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>fill <span class="token operator">=</span> fill<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>selected <span class="token operator">=</span> selected<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token operator">...</span>
<span class="token punctuation">&#125;</span></code></pre>

<p><code>Shape</code>는 <code>posX</code>, <code>posY</code>, <code>tempX</code>, <code>tempY</code>, <code>fill</code>, <code>selected</code> 속성을 가지고 있다. 이때 직렬화가 필요한 속성은 <code>posX</code>, <code>posY</code>, <code>fill</code>, <code>selected</code>다. <code>tempX</code>, <code>tempY</code>는 도형을 끄는 동안에 사용할 임시 값으로 실행 취소 / 다시 실행을 위해 따로 복사하지 않는다.</p>
<pre class="language-js" data-language="js"><code class="language-js"><span class="token function">createModelSchema</span><span class="token punctuation">(</span>Shape<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
  posX<span class="token operator">:</span> <span class="token function">primitive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  posY<span class="token operator">:</span> <span class="token function">primitive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  fill<span class="token operator">:</span> <span class="token function">primitive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  selected<span class="token operator">:</span> <span class="token function">primitive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p>직렬화할 속성을 정했으면 serializr의 <code>createModelSchema()</code>를 사용해서 스키마를 정의한다. 이렇게 정의한 스키마는 추후 직렬화 시 사용된다. </p>

    <div class="alert alert--info">
      
        <strong class="alert__title">
          스키마를 정의하는 법
        </strong>
      
      <div class="alert__body">
        <p>여기에서는 <code>createModelSchema()</code>를 사용하지만, decorator를 이용해 보다 깔끔하게 스키마를 정의할 수도 있다. 자세한 내용은 serializr 저장소를 참고한다.</p>

      </div>
    </div>
  

<pre class="language-js" data-language="js"><code class="language-js"><span class="token function">createModelSchema</span><span class="token punctuation">(</span>Circle<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
  cx<span class="token operator">:</span> <span class="token function">primitive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  cy<span class="token operator">:</span> <span class="token function">primitive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  r<span class="token operator">:</span> <span class="token function">primitive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">createModelSchema</span><span class="token punctuation">(</span>Square<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
  x<span class="token operator">:</span> <span class="token function">primitive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  y<span class="token operator">:</span> <span class="token function">primitive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  width<span class="token operator">:</span> <span class="token function">primitive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  height<span class="token operator">:</span> <span class="token function">primitive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">createModelSchema</span><span class="token punctuation">(</span>Triangle<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
  points<span class="token operator">:</span> <span class="token function">list</span><span class="token punctuation">(</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token function">primitive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p>이어서 <code>Shape</code>와 같은 방법으로 <code>Circle</code>, <code>Square</code>, <code>Triangle</code>에 대한 스키마를 정의한다. 그리고 <code>Shapes</code>에 객체의 상태를 복사할 수 있는 메서드와 복사본을 다시 되돌릴 수 있는 메서드를 추가한다.</p>
<pre class="language-js" data-language="js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Shapes</span> <span class="token punctuation">&#123;</span>
  <span class="token operator">...</span>
  <span class="token function">snapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_shapes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token function">restore</span><span class="token punctuation">(</span><span class="token parameter">dump</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_shapes <span class="token operator">=</span> dump<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    	<span class="token keyword">const</span> Shape <span class="token operator">=</span> <span class="token operator">??</span><span class="token operator">?</span><span class="token punctuation">;</span> <span class="token comment">/* 생성자를 알 수 없다 */</span>
    	<span class="token function">deserialize</span><span class="token punctuation">(</span>Shape<span class="token punctuation">,</span> data<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p><code>Shapes</code>에 <code>snapshot()</code>과 <code>restore()</code>를 추가했다. 각 메서드에서 사용하는 <code>serialize()</code>와 <code>deserialize()</code>는 serializr에서 제공하는 함수다.</p>
<p><code>snapshot()</code>은 간단하다. <code>_shapes</code>를 <code>serialize()</code>에 전달하기만 하면 된다. 그러면 serializr는 앞서 정의한 스키마를 토대로 플레인 자바스크립트 객체를 반환할 것이다.</p>
<p>하지만 <code>restore()</code>는 그렇지 않다. <code>deserialize()</code>의 첫 번째 인자로는 역직렬화 할 객체 생성자, 두 번째 인자엔 되돌릴 객체 상태를 전달해야 하는데 복사본만으로는 연관된 생성자를 알 수 없다. 이 문제를 해결하기 위해서 모델을 다음과 같이 수정한다.</p>
<pre class="language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> ShapeType <span class="token operator">=</span> <span class="token punctuation">&#123;</span> 
  Circle<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> 
  Square<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> 
  Triangle<span class="token operator">:</span> <span class="token number">2</span> 
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>

<p>우선 enum으로 사용할 <code>ShapeType</code> 객체를 추가한다. <code>ShapeType</code>은 <code>Circle</code>, <code>Square</code>, <code>Triangle</code>을 식별할 수 있는 값을 정수로 갖는다.</p>
<pre class="language-js" data-language="js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Shape</span> <span class="token punctuation">&#123;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">data <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token operator">...</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>shapeType <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token operator">...</span>
<span class="token punctuation">&#125;</span>

Shape<span class="token punctuation">.</span>shapeType <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Circle</span> <span class="token keyword">extends</span> <span class="token class-name">Shape</span> <span class="token punctuation">&#123;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">data <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  	<span class="token operator">...</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>shapeType <span class="token operator">=</span> ShapeType<span class="token punctuation">.</span>Circle<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

Circle<span class="token punctuation">.</span>shapeType <span class="token operator">=</span> ShapeType<span class="token punctuation">.</span>Circle<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Square</span> <span class="token keyword">extends</span> <span class="token class-name">Shape</span> <span class="token punctuation">&#123;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">data <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  	<span class="token operator">...</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>shapeType <span class="token operator">=</span> ShapeType<span class="token punctuation">.</span>Square<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

Square<span class="token punctuation">.</span>shapeType <span class="token operator">=</span> ShapeType<span class="token punctuation">.</span>Square<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Triangle</span> <span class="token keyword">extends</span> <span class="token class-name">Shape</span> <span class="token punctuation">&#123;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">data <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token operator">...</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>shapeType <span class="token operator">=</span> ShapeType<span class="token punctuation">.</span>Triangle<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

Triangle<span class="token punctuation">.</span>shapeType <span class="token operator">=</span> ShapeType<span class="token punctuation">.</span>Triangle<span class="token punctuation">;</span></code></pre>

<p>이어서 각 모델에 <code>shapeType</code> 속성을 추가하고 연관된 <code>ShapeType</code>을 대입한다. 이렇게 추가한 속성을 이용하면 연관된 생성자를 알 수 있다.</p>
<pre class="language-js" data-language="js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">getShapeClass</span><span class="token punctuation">(</span><span class="token parameter">shapeType</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token punctuation">[</span> Circle<span class="token punctuation">,</span> Square<span class="token punctuation">,</span> Triangle <span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter"><span class="token constant">C</span></span> <span class="token operator">=></span> <span class="token constant">C</span><span class="token punctuation">.</span>shapeType <span class="token operator">===</span> shapeType<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p><code>getShapeClass()</code>은 <code>shapeType</code> 인자를 이용해 해당하는 생성자를 반환한다. 이 함수를 사용해 <code>Shapes</code>의 <code>restore()</code>를 다음과 같이 수정한다.</p>
<pre class="language-js" data-language="js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Shapes</span> <span class="token punctuation">&#123;</span>
  <span class="token operator">...</span>
  <span class="token function">snapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_shapes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token function">restore</span><span class="token punctuation">(</span><span class="token parameter">snapshot</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_shapes <span class="token operator">=</span> snapshot<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">d</span> <span class="token operator">=></span> <span class="token function">deserialize</span><span class="token punctuation">(</span><span class="token function">getShapeClass</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>shapeType<span class="token punctuation">)</span><span class="token punctuation">,</span> d<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>이것으로 필요한 모델 수정은 모두 끝났다. 다음으로 실행 취소 / 다시 실행의 상태를 보관할 <code>History</code> 객체를 작성해보자.</p>
<h3 id="History-작성"><a href="#History-작성" class="headerlink" title="History 작성"></a>History 작성</h3><pre class="language-js" data-language="js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">History</span> <span class="token punctuation">&#123;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">shapes</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_undoStack <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_redoStack <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_shapes <span class="token operator">=</span> shapes<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> snapshot <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_shapes<span class="token punctuation">.</span><span class="token function">snapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_undoStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>snapshot<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_redoStack <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token function">undo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_undoStack<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> dump <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_undoStack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> snapshot <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_shapes<span class="token punctuation">.</span><span class="token function">snapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_redoStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>snapshot<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_shapes<span class="token punctuation">.</span><span class="token function">restore</span><span class="token punctuation">(</span>dump<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token function">redo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_redoStack<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> dump <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_redoStack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> snapshot <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_shapes<span class="token punctuation">.</span><span class="token function">snapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_undoStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>snapshot<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_shapes<span class="token punctuation">.</span><span class="token function">restore</span><span class="token punctuation">(</span>dump<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p><code>History</code>는 실행 취소 / 다시 실행 시 필요한 상태를 관리하고 실행하는 역할을 한다. </p>
<p><code>take()</code>는 <code>shapes</code>를 통해 현재 상태를 가져와 실행 취소 스택에 추가하고 다시 실행 스택을 비운다. 이 메서드는 모델의 상태가 변경되기 직전에 호출돼야 한다. </p>
<p><code>undo()</code>는 실행 취소 스택에서 전 상태를 하나 꺼내오는 동시에 <code>shapes</code>에서 현재 상태를 가져온다. 그리고 다시 실행 스택에 현재 상태를 추가하고 <code>shapes.restore()</code>에 전 상태를 전달해 상태를 되돌린다.</p>
<p><code>redo()</code>는 다시 실행 스택에서 앞 상태를 하나 꺼내오는 동시에 <code>shapes</code>에서 현재 상태를 가져온다. 그리고 실행 취소 스택에 현재 상태를 추가하고 <code>shapes.restore()</code>에 앞 상태를 전달해 상태를 되돌린다.</p>

    <div class="alert alert--info">
      
        <strong class="alert__title">
          메멘토 패턴
        </strong>
      
      <div class="alert__body">
        <figure title="메멘토 패턴">
  <a href="/images/2019/create-the-undo-redo-feature/undo-redo.02.png" target="_blank">
    <img 
      src="/images/2019/create-the-undo-redo-feature/undo-redo.02.png" 
      alt="메멘토 패턴" 
      style=""
    >
  </a>
</figure>

<p>이미 눈치챈 사람도 있겠지만 이것은 메멘토 패턴이다. 메멘토 패턴은 <code>Originator</code>에서 <code>Memento</code>(상태)를 가져와 <code>Cretaker</code>에 저장하고 추후 다시 꺼내 <code>Originator</code>에 전달하여 상태를 되돌리는 패턴을 말한다(<a target="_blank" rel="noopener" href="https://ko.wikipedia.org/wiki/%EB%A9%94%EB%A9%98%ED%86%A0_%ED%8C%A8%ED%84%B4">참고</a>).</p>

      </div>
    </div>
  

<p>이것으로 실행 취소 / 다시 실행을 위한 모든 준비를 마쳤다. 이제 각 이벤트 핸들러에서 필요에 따라 <code>History</code> 객체를 호출해주면 된다.</p>
<h3 id="이벤트-핸들러-수정"><a href="#이벤트-핸들러-수정" class="headerlink" title="이벤트 핸들러 수정"></a>이벤트 핸들러 수정</h3><pre class="language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> shapes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Shapes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> history <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">History</span><span class="token punctuation">(</span>shapes<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p>먼저 <code>shapes</code>를 생성한 후 이를 주입해 <code>history</code>를 생성한다.</p>
<pre class="language-js" data-language="js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token parameter">Shape</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  history<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 추가</span>
  <span class="token keyword">const</span> shape <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Shape</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> 
    posX<span class="token operator">:</span> <span class="token function">random</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
    posY<span class="token operator">:</span> <span class="token function">random</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">)</span> 
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  shapes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>shape<span class="token punctuation">)</span><span class="token punctuation">;</span>
  shapes<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span>shape<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>이어서 도형 생성 시 호출되는 <code>create()</code>를 살펴보자. 새로운 도형을 생성하기 전에 <code>history.take()</code>를 호출하여 현재 상태를 저장하도록 수정한다.</p>
<pre class="language-js" data-language="js"><code class="language-js">remove<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> shape <span class="token operator">=</span> shapes<span class="token punctuation">.</span><span class="token function">getSelected</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>shape<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    history<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 추가</span>
    shapes<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>shape<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre> 

<p>삭제도 마찬가지로 도형을 삭제하기 전 <code>history.take()</code>를 호출하여 현재 상태를 저장하도록 수정한다.</p>
<pre class="language-js" data-language="js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">handlePointerEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>dragging <span class="token operator">&amp;&amp;</span> shape<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>shape<span class="token punctuation">.</span>tempX <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      history<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 추가  </span>
    <span class="token punctuation">&#125;</span>
    shapes<span class="token punctuation">.</span><span class="token function">arrive</span><span class="token punctuation">(</span>shape<span class="token punctuation">)</span><span class="token punctuation">;</span>
    dragging <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    shape <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p><code>handlePointerEnd()</code>는 도형을 끌어다 놓는 시점(<code>mouseup</code> 또는 <code>touchend</code>)에 호출되는 이벤트 핸들러다. <code>shape</code>에 저장된 임시 위칫값이 적용되기 전에 <code>history.take()</code>를 호출하여 현재 상태를 저장하도록 수정한다. </p>
<p>만약 도형을 끄는 시점(<code>mousemove</code> 또는 <code>touchmove</code>)에 <code>posX</code>, <code>posY</code>의 값을 수정하면 <code>history.take()</code>를 호출할 때 이미 값이 변경돼 전 상태를 보관할 수 없다. 이것이 <code>tempX</code>, <code>tempY</code>를 사용하는 이유다.</p>
<pre class="language-js" data-language="js"><code class="language-js">undo<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> history<span class="token punctuation">.</span><span class="token function">undo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
redo<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> history<span class="token punctuation">.</span><span class="token function">redo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p>마지막으로 실행 취소 / 다시 실행 버튼을 추가하고 각 이벤트 핸들러에 <code>history</code>의 <code>undo()</code>, <code>redo()</code>가 호출되도록 작성한다. </p>
<h3 id="결과"><a href="#결과" class="headerlink" title="결과"></a>결과</h3><p>처음에 소개한 예제를 기반으로 차근차근 코드를 수정했다면 다음과 같이 실행 취소 / 다시 실행 기능이 적용된 애플리케이션이 완성될 것이다.</p>

    <p data-height="300" data-theme-id="0" data-slug-hash="VJMOxp" data-default-tab="result" data-user="uyeong" data-embed-version="2" data-pen-title="VJMOxp" class="codepen">
      See the Pen <a target="_blank" rel="noopener" href="http://codepen.io/uyeong/pen/VJMOxp/">VJMOxp</a> by Uyeong Ju (<a target="_blank" rel="noopener" href="http://codepen.io/uyeong">@uyeong</a>) on <a target="_blank" rel="noopener" href="http://codepen.io">CodePen</a>.
    </p>
  


<h2 id="끝으로"><a href="#끝으로" class="headerlink" title="끝으로"></a>끝으로</h2><p>여기까지 <code>serializr</code>를 활용해 손쉽게 실행 취소 / 다시 실행을 구현해봤다. 물론 이 방식을 실제 제품에 사용하기 위해선 다양한 측면에서의 테스트가 필요할 것이다. 하지만 원리 자체에 큰 차이가 없으므로 기능을 구현하는 데 있어 도움이 될 것으로 생각한다.</p>

      </div>
    </article>
    <div class="post__footer">
      <div class="post__navigation">
        <nav class="navigation">
  
  
  <div class="navigation__prev">
    
      <span class="navigation__guide">Next Post</span>
      <a href="/2019/07/19/prototype-pollution-attacks-in-nodejs/" class="navigation__link">
        <p class="navigation__title ellipsis">Node.js에서의 프로토타입 오염 공격이란 무엇인가</p>
      </a>
      <div class="navigation__meta">
        <div class="meta">
  <div class="meta__datetime">
    <i class="fa fa-clock-o" aria-hidden="true"></i>
    <time datetime="2019-07-19T00:00:00+09:00">
      2019.07.19
    </time>
  </div>
  <div class="meta__categories ellipsis">
    <i class="fa fa-map-marker" aria-hidden="true"></i>
    
      <div class="meta__category-list">
        
          <a href="/categories/JavaScript/" class="meta__category-list-item">
            <span>JavaScript</span>
          </a>
          
            <span>&nbsp/ </span>
          
        
          <a href="/categories/JavaScript/Security/" class="meta__category-list-item">
            <span>Security</span>
          </a>
          
        
      </div>
    
  </div>
</div>

      </div>
      <p class="navigation__desc">
        __proto__을 이용한 프로토타입 오염(prototype pollution) 공격의 원리를 설명하면서 노드 환경에서 실제 공격이 가능한 사례를 함께 소개합니다.
      </p>
    
  </div>
  <div class="navigation__next">
    
      <span class="navigation__guide">Previous Post</span>
      <a href="/2018/03/03/two-ways-to-work-with-backend-developer/" class="navigation__link">
        <p class="navigation__title ellipsis">백엔드 개발자와 협업하는 두 가지 방법</p>
      </a>
      <div class="navigation__meta">
        <div class="meta">
  <div class="meta__datetime">
    <i class="fa fa-clock-o" aria-hidden="true"></i>
    <time datetime="2018-03-03T00:00:00+09:00">
      2018.03.03
    </time>
  </div>
  <div class="meta__categories ellipsis">
    <i class="fa fa-map-marker" aria-hidden="true"></i>
    
      <div class="meta__category-list">
        
          <a href="/categories/Development/" class="meta__category-list-item">
            <span>Development</span>
          </a>
          
        
      </div>
    
  </div>
</div>

      </div>
      <p class="navigation__desc">
        이 문서는 백엔드 개발자와 협업하는 두 가지 방법을 정리한 문서로 API 협의 과정 또는 그러한 과정없이 애플리케이션을 개발하는 방법을 소개합니다.
      </p>
    
  </div>
</nav>

      </div>
      
        <div class="post__comments">
          <div id="disqus_thread"></div>
          <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="https://disqus.com/?ref_noscript">comments powered by
              Disqus.</a></noscript>
        </div>
      
    </div>
  </div>
</section>

  <footer class="footer">
  <div class="footer__media">
    <ul class="media">
  
    
      <li class="media__medium">
        
          <a href="mailto:uyeong21c@gmail.com">
            <i class="fa fa-envelope-o" aria-hidden="true"></i>
            <span class="blind">Email</span>
          </a>
        
      </li>
    
  
    
      <li class="media__medium">
        
          <a href="//twitter.com/coderifleman" target="_blank">
            <i class="fa fa-twitter" aria-hidden="true"></i>
            <span class="blind">Twitter</span>
          </a>
        
      </li>
    
  
    
      <li class="media__medium">
        
          <a href="//facebook.com/coderifleman" target="_blank">
            <i class="fa fa-facebook" aria-hidden="true"></i>
            <span class="blind">Facebook</span>
          </a>
        
      </li>
    
  
    
      <li class="media__medium">
        
          <a href="//github.com/uyeong" target="_blank">
            <i class="fa fa-github" aria-hidden="true"></i>
            <span class="blind">Github</span>
          </a>
        
      </li>
    
  
    
      <li class="media__medium">
        
          <a href="/atom.xml" target="_blank">
            <i class="fa fa-rss" aria-hidden="true"></i>
            <span class="blind">RSS</span>
          </a>
        
      </li>
    
  
</ul>

  </div>
  <div class="footer__copyright">
    © 2014–2023 Copyright by <a href="/">Coderifleman</a>.<br />
    All rights reserved.
  </div>
</footer>

</div>

  <script>
    var disqus_config = function () {
      this.page.url = 'http://blog.coderifleman.com/2019/06/29/create-the-undo-redo-feature/';
      this.page.identifier = '2019/06/29/create-the-undo-redo-feature/';
    };
    (function () {
      var dsq = document.createElement('script');
      dsq.type = 'text/javascript';
      dsq.async = true;
      dsq.src = '//coderifleman.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>


  <script>
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-55659240-1']);
    _gaq.push(['_setAllowLinker', true]);
    _gaq.push(['_trackPageview']);
    (function () {
      var ga = document.createElement('script');
      ga.type = 'text/javascript';
      ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(ga, s);
    })();
  </script>


<script src="//production-assets.codepen.io/assets/embed/ei.js"></script>


<script src="/script.js"></script>

</body>
</html>

